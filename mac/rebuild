#!/usr/bin/env python3
"""
Rebuild script for DividiaOverlayBurner application.
Run this after making changes to overlay_burner.py or automator_shell_script.
This script will:
1. Create/activate virtual environment
2. Install dependencies (PyInstaller)
3. Build the executable
4. Copy files to app bundle
"""

import subprocess
import sys
import os
import shutil
from pathlib import Path

def run_command(cmd, description, shell=False, cwd=None):
    """Run a shell command and report status."""
    print(f"\n{'='*60}")
    print(f"  {description}")
    print(f"{'='*60}")
    if isinstance(cmd, list):
        print(f"$ {' '.join(cmd)}")
    else:
        print(f"$ {cmd}")
    
    result = subprocess.run(cmd, capture_output=False, shell=shell, cwd=cwd)
    
    if result.returncode != 0:
        print(f"[ERROR] {description} failed!")
        sys.exit(1)
    
    print(f"[OK] {description} completed successfully")

def main():
    print("\n[DividiaOverlayBurner Rebuild Script]")
    print("="*60)
    
    # Get current directory
    base_dir = Path(__file__).parent
    venv_dir = base_dir / "overlay_env"
    
    # Determine Python executable path in venv
    if sys.platform == "win32":
        venv_python = venv_dir / "Scripts" / "python.exe"
        venv_pip = venv_dir / "Scripts" / "pip.exe"
        venv_pyinstaller = venv_dir / "Scripts" / "pyinstaller.exe"
    else:
        venv_python = venv_dir / "bin" / "python"
        venv_pip = venv_dir / "bin" / "pip"
        venv_pyinstaller = venv_dir / "bin" / "pyinstaller"
    
    # 1. Create virtual environment if it doesn't exist or is corrupted
    # Test if venv is functional by checking if pip can actually run
    venv_needs_rebuild = False
    
    if not venv_dir.exists():
        venv_needs_rebuild = True
    else:
        # Test if pip actually works (checks shebang is correct)
        try:
            test_result = subprocess.run(
                [str(venv_pip), "--version"],
                capture_output=True,
                timeout=5
            )
            if test_result.returncode != 0:
                venv_needs_rebuild = True
                print("\n[WARNING] Virtual environment pip is broken")
        except (FileNotFoundError, subprocess.TimeoutExpired):
            venv_needs_rebuild = True
            print("\n[WARNING] Virtual environment is corrupted")
    
    if venv_needs_rebuild:
        if venv_dir.exists():
            print("Removing corrupted virtual environment...")
            shutil.rmtree(venv_dir)
        run_command(
            [sys.executable, "-m", "venv", "overlay_env"],
            "Creating virtual environment"
        )
    else:
        print("\n[OK] Virtual environment already exists")
    
    # 2. Install/upgrade PyInstaller in the venv
    run_command(
        [str(venv_pip), "install", "--upgrade", "pyinstaller"],
        "Installing/updating PyInstaller"
    )
    
    # 3. Build executable with PyInstaller using venv
    run_command(
        [str(venv_pyinstaller), "--clean", "--onefile", "--name", "DividiaOverlayBurner", "../common/overlay_burner.py"],
        "Building DividiaOverlayBurner executable"
    )
    
    # 4. Copy executable to app bundle
    run_command(
        ["cp", "dist/DividiaOverlayBurner", "./DividiaOverlayBurner.app/Contents/Resources/"],
        "Copying executable to app bundle"
    )
    
    # 5. Make executable
    run_command(
        ["chmod", "+x", "./DividiaOverlayBurner.app/Contents/Resources/DividiaOverlayBurner"],
        "Setting executable permissions"
    )
    
    # 6. Copy ffmpeg
    ffmpeg_path = base_dir / "ffmpeg"
    if ffmpeg_path.exists():
        run_command(
            ["cp", "ffmpeg", "./DividiaOverlayBurner.app/Contents/Resources/"],
            "Copying ffmpeg to app bundle"
        )
    else:
        print(f"\n[WARNING] ffmpeg not found at {ffmpeg_path}")
        print("You may need to manually copy ffmpeg to the app bundle.")
    
    print("\n" + "="*60)
    print("[SUCCESS] Rebuild complete!")
    print("="*60)
    print("\nDividiaOverlayBurner.app is ready to use")
    print(f"   Location: {base_dir / 'DividiaOverlayBurner.app'}")
    print("\n[NOTE] Don't forget to update automator_shell_script in Automator if you made changes to it!")
    print()

if __name__ == "__main__":
    main()
